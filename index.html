<script>
/* ======================= SAFE UTILS (NO CRASH) ======================= */
// Safe storage shim (won't throw in private mode / sandboxed iframes)
const LS = (() => {
  try {
    const t = "__rbx_test__";
    window.localStorage.setItem(t, "1");
    window.localStorage.removeItem(t);
    return {
      get: (k) => window.localStorage.getItem(k),
      set: (k, v) => window.localStorage.setItem(k, v),
      remove: (k) => window.localStorage.removeItem(k),
    };
  } catch {
    const mem = {};
    return {
      get: (k) => (k in mem ? mem[k] : null),
      set: (k, v) => { mem[k] = String(v); },
      remove: (k) => { delete mem[k]; },
    };
  }
})();

// Safe matchMedia
const hasMM = typeof window.matchMedia === "function";
const prefersLight = hasMM ? !!window.matchMedia("(prefers-color-scheme: light)").matches : false;

// Tiny helper
const $ = (s) => document.querySelector(s);
const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

// Global, but only after DOM ready to avoid null refs
let MODE = "game";
let lastSearchAt = 0;
let cooldownTimer = null;

const COOLDOWN_MS = 3500;
const BOOK_KEY = "rbx_lookup_bookmarks_v1";
const RECENT_KEY = "rbx_lookup_recent_v1";
const THEME_KEY = "rbx_lookup_theme";

const GAME_CACHE = new Map();
const LAST_RESULTS = { games: [] };

// Roblox proxied endpoints (CORS-friendly)
const RBX = {
  apis: "https://apis.roproxy.com",
  games: "https://games.roproxy.com",
  thumbs: "https://thumbnails.roproxy.com",
  users: "https://users.roproxy.com",
  friends: "https://friends.roproxy.com",
  presence: "https://presence.roproxy.com",
};

/* ======================= THEME (SAFE) ======================= */
function applyTheme(theme) {
  const t = theme === "light" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", t);
  LS.set(THEME_KEY, t);
  const btn = $("#themeBtn");
  if (btn) btn.textContent = t === "light" ? "Dark mode" : "Light mode";
}
function toggleTheme() {
  const cur = LS.get(THEME_KEY) || (prefersLight ? "light" : "dark");
  applyTheme(cur === "dark" ? "light" : "dark");
}

/* ======================= HELPERS ======================= */
async function j(url, opt = {}) {
  const r = await fetch(url, { ...opt, cache: "no-store" });
  if (!r.ok) throw new Error("HTTP " + r.status);
  return r.json();
}
function n(x) {
  return typeof x === "number" ? x.toLocaleString() : "N/A";
}
function likeRatio(up, down) {
  const u = +up || 0, d = +down || 0, t = u + d;
  if (!t) return { cls: "ratio-mid", label: "0%" };
  const p = Math.round((u / t) * 100);
  return { cls: p >= 80 ? "ratio-good" : p >= 60 ? "ratio-mid" : "ratio-bad", label: p + "%" };
}

/* ======================= SKELETON ======================= */
const sk = () => `
  <div class="skeleton"><div class="shimmer"></div>
    <div class="sk-row">
      <div class="sk-ava"></div>
      <div class="sk-lines">
        <div class="sk-line long"></div>
        <div class="sk-line med"></div>
        <div class="sk-line short"></div>
      </div>
    </div>
  </div>`;

/* ======================= GAME LOOKUP ======================= */
async function autoUniverses(q) {
  const url = `${RBX.apis}/games-autocomplete/v1/get-suggestion/${encodeURIComponent(q)}`;
  const data = await j(url).catch(() => ({ entries: [] }));
  const ids = new Set();
  (data.entries || []).forEach((e) => { if (e?.universeId > 0) ids.add(e.universeId); });
  return [...ids];
}
async function placeToUniverse(placeId) {
  try {
    const u = await j(`${RBX.apis}/universes/v1/places/${placeId}/universe`);
    return u.universeId || u?.data?.universeId || u?.data?.[0]?.universeId || null;
  } catch { return null; }
}
async function gameDetails(universeIds) {
  if (!universeIds.length) return [];
  const chunks = [];
  for (let i = 0; i < universeIds.length; i += 50) chunks.push(universeIds.slice(i, i + 50));
  const all = [];
  for (const group of chunks) {
    const ids = group.join(",");
    const [games, thumbs, votes] = await Promise.all([
      j(`${RBX.games}/v1/games?universeIds=${ids}`).catch(() => ({ data: [] })),
      j(`${RBX.thumbs}/v1/games/icons?universeIds=${ids}&size=150x150&format=Png&isCircular=false`).catch(() => ({ data: [] })),
      j(`${RBX.games}/v1/games/votes?universeIds=${ids}`).catch(() => ({ data: [] })),
    ]);
    const t = new Map(); (thumbs.data || []).forEach((a) => t.set(String(a.targetId), a.imageUrl));
    const v = new Map(); (votes.data || []).forEach((x) =>
      v.set(String(x.id || x.universeId || x.targetId), { up: x.upVotes ?? 0, down: x.downVotes ?? 0 })
    );
    (games.data || []).forEach((g) => {
      const key = String(g.id), vv = v.get(key) || { up: g.totalUpVotes ?? 0, down: g.totalDownVotes ?? 0 };
      all.push({
        id: g.id, rootPlaceId: g.rootPlaceId, name: g.name, creator: g.creator?.name || "Unknown",
        visits: g.visits ?? 0, playing: g.playing ?? 0, favorites: g.favoritedCount ?? 0,
        up: vv.up || 0, down: vv.down || 0, thumb: t.get(key) || "",
      });
    });
    await sleep(60);
  }
  return all;
}
function paintGames(arr) {
  const res = $("#out");
  if (!arr.length) { res.innerHTML = `<div class="card"><p class="error">No games found.</p></div>`; return; }
  let html = `<div class="card"><h2 style="text-align:center;margin:0 0 8px">Games</h2><div class="list">`;
  for (const g of arr) {
    GAME_CACHE.set(g.id, g);
    const lr = likeRatio(g.up, g.down);
    html += `
      <div class="item" data-view-game="${g.id}">
        <div class="row2">
          <img class="thumb" loading="lazy" src="${g.thumb}" onerror="this.src='https://placehold.co/150x150?text=Game'">
          <div class="info">
            <h2>${g.name}</h2>
            <div class="meta">
              <span class="tag">Creator: ${g.creator}</span>
              <span>Visits: <b>${n(g.visits)}</b></span>
              <span>Playing: <b>${n(g.playing)}</b></span>
              <span>Likes: <b class="${lr.cls}">${lr.label}</b></span>
            </div>
          </div>
        </div>
      </div>`;
  }
  html += `</div></div>`;
  res.innerHTML = html;
  res.querySelectorAll("[data-view-game]").forEach((el) => {
    el.addEventListener("click", () => viewGame(el.getAttribute("data-view-game")));
  });
}
function paintGame(g) {
  const lr = likeRatio(g.up, g.down);
  $("#out").innerHTML = `
    <div class="card">
      <div class="header-row">
        <img class="thumb" src="${g.thumb}" onerror="this.src='https://placehold.co/150x150?text=Game'">
        <div class="info">
          <h2 style="text-align:center">${g.name}</h2>
          <div class="chips">
            <span class="chip">Creator: ${g.creator}</span>
            <span class="chip">Visits: ${n(g.visits)}</span>
            <span class="chip">Playing: ${n(g.playing)}</span>
            <span class="chip">Favorites: ${n(g.favorites)}</span>
          </div>
          <p style="text-align:center;margin-top:6px"><b>Likes</b> <span class="${lr.cls}">${lr.label}</span> <span class="muted">(${n(g.up)} / ${n(g.down)})</span></p>
          <div style="display:flex;justify-content:center;gap:8px;margin-top:8px;flex-wrap:wrap">
            <a class="btn" target="_blank" rel="noopener" href="https://www.roblox.com/games/${g.rootPlaceId}">Play</a>
            <button class="btn" id="bmGame">Bookmark</button>
            <button class="btn" id="copyUni">Copy Universe ID</button>
          </div>
        </div>
      </div>
    </div>`;
  $("#bmGame").addEventListener("click", () => bookmark("game", g.id));
  $("#copyUni").addEventListener("click", () => navigator.clipboard?.writeText(String(g.id)));
}

/* ======================= USER LOOKUP ======================= */
async function userLookup(q) {
  const out = $("#out");
  out.innerHTML = `<div class="card"><div class="loader"><div class="spinner"></div><div>Looking up user…</div></div></div>` + sk();
  let id = q.trim();
  if (!/^\d+$/.test(id)) {
    const r = await j(`${RBX.users}/v1/usernames/users`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ usernames: [id.toLowerCase()], excludeBannedUsers: false }),
    });
    if (!r?.data?.[0]) throw new Error("User not found");
    id = String(r.data[0].id);
  }
  const [u, ava, fri, fol, folw, pre] = await Promise.all([
    j(`${RBX.users}/v1/users/${id}`),
    j(`${RBX.thumbs}/v1/users/avatar-headshot?userIds=${id}&size=180x180&format=Png&isCircular=false`),
    j(`${RBX.friends}/v1/users/${id}/friends/count`),
    j(`${RBX.friends}/v1/users/${id}/followers/count`),
    j(`${RBX.friends}/v1/users/${id}/followings/count`),
    j(`${RBX.presence}/v1/presence/users`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ userIds: [Number(id)] }) }),
  ]);

  const url = ava?.data?.[0]?.imageUrl || "https://placehold.co/180x180?text=Avatar";
  const created = u.created ? new Date(u.created).toLocaleString() : "Unavailable";
  const pt = pre?.userPresences?.[0]?.userPresenceType;
  let sClass = "offline", sText = "Offline";
  if (pt === 1) { sClass = "online"; sText = "Online"; }
  else if (pt === 2) { sClass = "playing"; sText = "In Game"; }
  else if (pt === 3) { sClass = "studio"; sText = "In Studio"; }

  out.innerHTML = `
    <div class="card">
      <div class="header-row">
        <img class="avatar" src="${url}" onerror="this.src='https://placehold.co/180x180?text=Avatar'">
        <div class="info">
          <h2 style="text-align:center">${u.name || "Unknown"} <span class="muted">(${u.displayName || "Unknown"})</span></h2>
          <div class="chips">
            <span class="chip">Created: ${created}</span>
            <span class="chip">Friends: ${n(fri.count)}</span>
            <span class="chip">Followers: ${n(fol.count)}</span>
            <span class="chip">Following: ${n(folw.count)}</span>
          </div>
          <p style="text-align:center;margin-top:6px"><b>Bio:</b> ${
            u.description
              ? String(u.description).replace(/[&<>]/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[m])).replace(/\n/g, "<br>")
              : '<span class="muted">None</span>'
          }</p>
          <div style="display:flex;justify-content:center;gap:8px;margin-top:8px;flex-wrap:wrap">
            <a class="btn" target="_blank" rel="noopener" href="https://www.roblox.com/users/${u.id}/profile">Open Profile</a>
            <button class="btn" id="bmUser">Bookmark</button>
            <button class="btn" id="copyUid">Copy User ID</button>
          </div>
        </div>
      </div>
      <div class="pill ${sClass}" style="position:absolute; top:16px; right:16px">${sText}</div>
    </div>`;
  $("#bmUser").addEventListener("click", () => bookmark("user", String(u.id)));
  $("#copyUid").addEventListener("click", () => navigator.clipboard?.writeText(String(u.id)));
}

/* ======================= CONTROLS / SEARCH ======================= */
function startCooldown() {
  const b = $("#go");
  b.disabled = true;
  let left = COOLDOWN_MS;
  b.textContent = `Search ${Math.ceil(left / 1000)}s`;
  cooldownTimer = setInterval(() => {
    left -= 1000;
    if (left <= 0) {
      clearInterval(cooldownTimer);
      b.disabled = false;
      b.textContent = "Search";
    } else b.textContent = `Search ${Math.ceil(left / 1000)}s`;
  }, 1000);
}
function setMode(m) {
  MODE = m;
  $("#tab-game").classList.toggle("active", m === "game");
  $("#tab-user").classList.toggle("active", m === "user");
  $("#tab-game").setAttribute("aria-selected", m === "game");
  $("#tab-user").setAttribute("aria-selected", m === "user");
  $("#badge").textContent = "Mode: " + (m === "game" ? "Game" : "User");
  $("#q").focus();
}
function clearResults() { $("#out").innerHTML = ""; }

async function lookup() {
  const now = Date.now();
  if (now < lastSearchAt + COOLDOWN_MS) return;
  lastSearchAt = now;

  const q = $("#q").value.trim();
  if (!q) { $("#out").innerHTML = `<div class="card"><p class="error">Type something to search.</p></div>`; return; }

  startCooldown();
  saveRecent(q);

  try {
    if (MODE === "user") { await userLookup(q); return; }

    $("#out").innerHTML =
      `<div class="card"><div class="loader"><div class="spinner"></div><div>Searching games…</div></div></div>` + sk() + sk();

    let ids = [];
    if (/^\d+$/.test(q)) {
      const uniDirect = await gameDetails([Number(q)]);
      if (uniDirect.length) { LAST_RESULTS.games = uniDirect; applyControls(); return; }
      const uni = await placeToUniverse(q);
      if (uni) ids = [uni];
    } else {
      ids = await autoUniverses(q);
    }

    if (!ids.length) { $("#out").innerHTML = `<div class="card"><p class="error">No games found. Try another name or an ID.</p></div>`; return; }
    const games = await gameDetails(ids);
    LAST_RESULTS.games = games.slice();
    applyControls();
  } catch (e) {
    console.error(e);
    $("#out").innerHTML = `<div class="card"><p class="error">Search failed. ${e.message || ""}</p></div>`;
    // If we failed instantly, reset the cooldown button so UX isn't stuck
    if (cooldownTimer) { clearInterval(cooldownTimer); const b = $("#go"); b.disabled = false; b.textContent = "Search"; }
  }
}

function applyControls() {
  if (!LAST_RESULTS.games.length) return;
  const minP = Number($("#minPlayers").value || 0);
  const minV = Number($("#minVisits").value || 0);
  let arr = LAST_RESULTS.games.filter((g) => g.playing >= minP && g.visits >= minV);

  const sort = $("#sortSel").value;
  const likePct = (g) => { const t = g.up + g.down; return t ? (g.up / t) : 0; };
  arr.sort((a, b) => {
    switch (sort) {
      case "playing": return (b.playing || 0) - (a.playing || 0);
      case "favorites": return (b.favorites || 0) - (a.favorites || 0);
      case "likes": return likePct(b) - likePct(a);
      case "name": return String(a.name).localeCompare(String(b.name));
      default: return (b.visits || 0) - (a.visits || 0);
    }
  });
  paintGames(arr);
}

async function viewGame(id) {
  let g = GAME_CACHE.get(Number(id));
  if (!g) { const arr = await gameDetails([Number(id)]).catch(() => []); g = arr[0]; }
  if (!g) { $("#out").innerHTML = `<div class="card"><p class="error">Couldn’t load that game.</p></div>`; return; }
  paintGame(g);
}

/* ======================= BOOKMARKS / RECENT / SHARE (SAFE LS) ======================= */
function bookmark(type, id) {
  let data;
  try { data = JSON.parse(LS.get(BOOK_KEY) || "{}"); } catch { data = {}; }
  if (!data[type]) data[type] = [];
  if (!data[type].includes(String(id))) data[type].unshift(String(id));
  LS.set(BOOK_KEY, JSON.stringify(data));
  alert("Saved to bookmarks!");
}
async function showBookmarks() {
  let data;
  try { data = JSON.parse(LS.get(BOOK_KEY) || "{}"); } catch { data = {}; }
  const gIds = (data.game || []).slice(0, 40).map(Number);
  const uIds = (data.user || []).slice(0, 40).map(Number);
  let html = `<div class="card"><h2 style="text-align:center;margin:0 0 8px">My Bookmarks</h2>`;
  if (gIds.length) {
    const games = await gameDetails(gIds);
    html += `<h3 style="text-align:center">Games</h3><div class="list">` +
      games.map(g => `<div class="item" data-view-game="${g.id}"><div class="row2"><img class="thumb" src="${g.thumb}" onerror="this.src='https://placehold.co/150x150?text=Game'"><div class="info"><h2>${g.name}</h2><div class="meta"><span>Visits: ${n(g.visits)}</span></div></div></div></div>`).join("") +
      `</div>`;
  }
  if (uIds.length) {
    html += `<h3 style="text-align:center;margin-top:12px">Users</h3><div class="list">` +
      uIds.map(uid => `<div class="item" data-open-user="${uid}"><div class="row2"><div class="info"><h2 style="text-align:center">User ID ${uid}</h2><div class="meta"><span>Click to open</span></div></div></div></div>`).join("") +
      `</div>`;
  }
  if (!gIds.length && !uIds.length) html += `<p class="muted" style="text-align:center">No bookmarks yet.</p>`;
  html += `</div>`;
  $("#out").innerHTML = html;

  $("#out").querySelectorAll("[data-view-game]").forEach(el => {
    el.addEventListener("click", () => viewGame(el.getAttribute("data-view-game")));
  });
  $("#out").querySelectorAll("[data-open-user]").forEach(el => {
    el.addEventListener("click", () => {
      setMode("user"); $("#q").value = el.getAttribute("data-open-user"); lookup();
    });
  });
}
function exportBookmarks() {
  const data = LS.get(BOOK_KEY) || "{}";
  const blob = new Blob([data], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "roblox-bookmarks.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function importBookmarks(file) {
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(String(reader.result || "{}"));
      LS.set(BOOK_KEY, JSON.stringify(data || {}));
      alert("Imported!");
    } catch { alert("Invalid JSON file."); }
  };
  reader.readAsText(file);
}
function saveRecent(q) {
  let arr;
  try { arr = JSON.parse(LS.get(RECENT_KEY) || "[]"); } catch { arr = []; }
  arr = arr.filter(x => x !== q);
  arr.unshift(q); while (arr.length > 15) arr.pop();
  LS.set(RECENT_KEY, JSON.stringify(arr));
}
function showRecent() {
  let arr;
  try { arr = JSON.parse(LS.get(RECENT_KEY) || "[]"); } catch { arr = []; }
  if (!arr.length) { alert("No recent searches yet."); return; }
  $("#out").innerHTML =
    `<div class="card"><h2 style="text-align:center;margin:0 0 8px">Recent searches</h2><div class="list">` +
    arr.map(q => `<div class="item" data-re-search="${q.replace(/"/g, "&quot;")}"><div class="row2"><div class="info"><h2 style="text-align:center">${q}</h2><div class="meta"><span>Click to search</span></div></div></div></div>`).join("") +
    `</div></div>`;
  $("#out").querySelectorAll("[data-re-search]").forEach(el => {
    el.addEventListener("click", () => { $("#q").value = el.getAttribute("data-re-search"); lookup(); });
  });
}
function copyLink() {
  const p = new URLSearchParams(); p.set("mode", MODE);
  const q = $("#q").value.trim(); if (q) p.set("q", q);
  const base = (location.origin && location.origin !== "null") ? (location.origin + location.pathname) : location.href.split("?")[0];
  const link = `${base}?${p.toString()}`;
  navigator.clipboard?.writeText(link).then(() => {
    const b = $("#copyBtn"); b.textContent = "Copied!"; setTimeout(() => b.textContent = "Copy link", 1200);
  });
}

/* ======================= COMPARE ======================= */
async function idFromNameOrId(x) {
  let id = String(x).trim();
  if (/^\d+$/.test(id)) return id;
  const r = await j(`${RBX.users}/v1/usernames/users`, {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usernames: [id.toLowerCase()], excludeBannedUsers: false }),
  });
  if (!r?.data?.[0]) throw new Error("User not found: " + x);
  return String(r.data[0].id);
}
async function getUserLite(id) {
  const [u, fri, fol, folw] = await Promise.all([
    j(`${RBX.users}/v1/users/${id}`),
    j(`${RBX.friends}/v1/users/${id}/friends/count`),
    j(`${RBX.friends}/v1/users/${id}/followers/count`),
    j(`${RBX.friends}/v1/users/${id}/followings/count`),
  ]);
  return { id: u.id, name: u.name, displayName: u.displayName, created: u.created, friends: fri.count, followers: fol.count, following: folw.count };
}
async function compareUsers() {
  const a = $("#cmpA").value.trim(), b = $("#cmpB").value.trim();
  if (!a || !b) { $("#cmpOut").textContent = "Enter two usernames or IDs."; return; }
  $("#cmpOut").innerHTML = '<div class="loader"><div class="spinner"></div><div>Comparing…</div></div>';
  try {
    const [idA, idB] = await Promise.all([idFromNameOrId(a), idFromNameOrId(b)]);
    const [ua, ub] = await Promise.all([getUserLite(idA), getUserLite(idB)]);
    const older = new Date(ua.created) < new Date(ub.created) ? ua : ub;
    $("#cmpOut").innerHTML = `
      <div class="list">
        <div class="item" tabindex="0">
          <div class="info">
            <h2 style="text-align:center">${ua.name} <span class="muted">(${ua.displayName})</span></h2>
            <div class="meta"><span>Friends: <b>${n(ua.friends)}</b></span><span>Followers: <b>${n(ua.followers)}</b></span><span>Following: <b>${n(ua.following)}</b></span><span>Created: ${new Date(ua.created).toLocaleDateString()}</span></div>
          </div>
        </div>
        <div class="item" tabindex="0">
          <div class="info">
            <h2 style="text-align:center">${ub.name} <span class="muted">(${ub.displayName})</span></h2>
            <div class="meta"><span>Friends: <b>${n(ub.friends)}</b></span><span>Followers: <b>${n(ub.followers)}</b></span><span>Following: <b>${n(ub.following)}</b></span><span>Created: ${new Date(ub.created).toLocaleDateString()}</span></div>
          </div>
        </div>
      </div>
      <p class="muted" style="text-align:center;margin-top:8px">Older account: <b>${older.name}</b></p>
    `;
  } catch (e) { $("#cmpOut").textContent = e.message || "Compare failed."; }
}

/* ======================= CONTACT FORM ======================= */
const FORM_ENDPOINT = "https://formsubmit.co/ajax/supp.roxzy@gmail.com";
async function sendContact(e) {
  e.preventDefault();
  const btn = $("#sendBtn");
  const gmailBtn = $("#gmailBtn");
  const note = $("#sendNote");
  btn.disabled = true; btn.textContent = "Sending…"; gmailBtn.style.display = "none"; note.textContent = "";

  const payload = {
    name: $("#cName").value.trim(),
    email: $("#cEmail").value.trim(),
    subject: $("#cSubject").value.trim(),
    message: $("#cMessage").value.trim(),
  };
  try {
    const r = await fetch(FORM_ENDPOINT, {
      method: "POST", headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify(payload),
    });
    const data = await r.json().catch(() => ({}));
    if (r.ok && (data.success || data.message)) {
      note.textContent = "✓ Message sent. Watch your inbox for a reply.";
      btn.textContent = "Sent"; setTimeout(() => { btn.disabled = false; btn.textContent = "Send message"; }, 2000);
      e.target.reset();
    } else { throw new Error("Service error"); }
  } catch {
    note.textContent = "Could not send via service. You can send quickly via Gmail Web.";
    gmailBtn.style.display = "inline-block";
    gmailBtn.onclick = () => {
      const u = new URL("https://mail.google.com/mail/");
      u.searchParams.set("view", "cm");
      u.searchParams.set("to", "supp.roxzy@gmail.com");
      u.searchParams.set("su", payload.subject || "Roblox Lookup message");
      u.searchParams.set("body", `${payload.message}\n\nFrom: ${payload.name} <${payload.email}>`);
      window.open(u.toString(), "_blank");
    };
    btn.disabled = false; btn.textContent = "Send message";
  }
}

/* ======================= INIT (AFTER DOM READY) ======================= */
function bindEvents() {
  // tabs
  $("#tab-game").addEventListener("click", () => setMode("game"));
  $("#tab-user").addEventListener("click", () => setMode("user"));

  // main actions
  $("#go").addEventListener("click", lookup);
  $("#applyBtn").addEventListener("click", applyControls);
  $("#randBtn").addEventListener("click", () => {
    const list = LAST_RESULTS.games;
    if (!list.length) { alert("Search first!"); return; }
    const pick = list[Math.floor(Math.random() * list.length)];
    viewGame(pick.id);
  });
  $("#themeBtn").addEventListener("click", toggleTheme);

  // tools
  $("#copyBtn").addEventListener("click", copyLink);
  $("#booksBtn").addEventListener("click", showBookmarks);
  $("#exportBtn").addEventListener("click", exportBookmarks);
  $("#recentBtn").addEventListener("click", showRecent);
  $("#clearBtn").addEventListener("click", clearResults);
  $("#importFile").addEventListener("change", (e) => { if (e.target.files?.[0]) importBookmarks(e.target.files[0]); });

  // compare
  $("#cmpBtn").addEventListener("click", compareUsers);

  // contact
  $("#contactForm").addEventListener("submit", sendContact);

  // shortcuts
  document.addEventListener("keydown", (e) => {
    if (e.key === "/" && document.activeElement !== $("#q")) { e.preventDefault(); $("#q").focus(); }
    if (e.key === "Enter" && document.activeElement === $("#q")) lookup();
    const k = e.key.toLowerCase(); if (k === "g") setMode("game"); if (k === "u") setMode("user");
  });

  // deep link
  const p = new URLSearchParams(location.search);
  const m = p.get("mode"); if (m === "user" || m === "game") setMode(m);
  const q = p.get("q"); if (q) { $("#q").value = q; lookup(); }
}

// Show a friendly error instead of silently breaking (helps debugging/AdSense QA)
window.addEventListener("error", (ev) => {
  const out = $("#out");
  if (!out) return;
  out.innerHTML = `<div class="card"><p class="error">A script error occurred: ${ev.message}. Try refreshing or switching Light/Dark. If this keeps happening, private mode or content blockers might be blocking storage or scripts.</p></div>` + (sk());
});

// Apply theme safely before UI paints too much
document.addEventListener("DOMContentLoaded", () => {
  const initialTheme = LS.get(THEME_KEY) || (prefersLight ? "light" : "dark");
  applyTheme(initialTheme);
  bindEvents();

  // Tiny UX: example queries to encourage interaction (good for engagement)
  const q = $("#q");
  if (q && !q.value) {
    q.setAttribute("list", "examples");
    const dl = document.createElement("datalist");
    dl.id = "examples";
    dl.innerHTML = [
      "doors", "er:lc", "adopt me", "brookhaven", "blox fruits",
      "frontlines", "shindo life", "universe id 4520749081"
    ].map(v => `<option value="${v}"></option>`).join("");
    document.body.appendChild(dl);
  }
});
</script>
